var e=Object.defineProperty,t=(t,s,i)=>((t,s,i)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i)(t,"symbol"!=typeof s?s+"":s,i);import{W as s,P as i,A as r,s as n,S as a}from"./three-core-Dyp1TTyn.js";const h=class e{static getInstance(){return e.instance||(e.instance=new e),e.instance}constructor(){if(e.instance)throw new Error("EventBus is a singleton. Use getInstance()");this.listeners=new Map,this.onceListeners=new Map}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.off(e,t)}once(e,t){this.onceListeners.has(e)||this.onceListeners.set(e,new Set),this.onceListeners.get(e).add(t)}off(e,t){this.listeners.has(e)&&this.listeners.get(e).delete(t),this.onceListeners.has(e)&&this.onceListeners.get(e).delete(t)}emit(e,t){this.listeners.has(e)&&this.listeners.get(e).forEach(e=>{try{e(t)}catch(s){}}),this.onceListeners.has(e)&&(this.onceListeners.get(e).forEach(e=>{try{e(t)}catch(s){}}),this.onceListeners.delete(e))}clear(e){this.listeners.delete(e),this.onceListeners.delete(e)}clearAll(){this.listeners.clear(),this.onceListeners.clear()}listenerCount(e){return(this.listeners.has(e)?this.listeners.get(e).size:0)+(this.onceListeners.has(e)?this.onceListeners.get(e).size:0)}};t(h,"instance",null);let o=h;const l=class e{static getInstance(){return e.instance||(e.instance=new e),e.instance}constructor(){if(e.instance)throw new Error("PerformanceMonitor is a singleton. Use getInstance()");this.eventBus=o.getInstance(),this.fps=60,this.frameTime=0,this.lastTime=performance.now(),this.frames=0,this.fpsUpdateInterval=1e3,this.lastFpsUpdate=performance.now(),this.qualityLevels={HIGH:{pixelRatio:2,shadows:!0,particles:1e3,antialiasing:!0},MEDIUM:{pixelRatio:1.5,shadows:!0,particles:500,antialiasing:!0},LOW:{pixelRatio:1,shadows:!1,particles:200,antialiasing:!1}},this.currentQuality="HIGH",this.targetFPS=60,this.minAcceptableFPS=30,this.autoQualityAdjust=!0,this.frameTimes=[],this.maxFrameTimeSamples=60,this.memoryWarningThreshold=.8}begin(){this.beginTime=performance.now()}end(){const e=performance.now();this.frameTime=e-this.beginTime,this.frames++,this.frameTimes.push(this.frameTime),this.frameTimes.length>this.maxFrameTimeSamples&&this.frameTimes.shift(),e-this.lastFpsUpdate>=this.fpsUpdateInterval&&(this.fps=Math.round(1e3*this.frames/(e-this.lastFpsUpdate)),this.frames=0,this.lastFpsUpdate=e,this.autoQualityAdjust&&this.adjustQuality(),this.eventBus.emit("performance:fps",{fps:this.fps})),this.lastTime=e}getFPS(){return this.fps}getAverageFrameTime(){if(0===this.frameTimes.length)return 0;return this.frameTimes.reduce((e,t)=>e+t,0)/this.frameTimes.length}getQuality(){return this.currentQuality}setQuality(e){this.qualityLevels[e]&&(this.currentQuality=e,this.eventBus.emit("performance:quality-changed",{quality:e,settings:this.qualityLevels[e]}))}getQualitySettings(){return this.qualityLevels[this.currentQuality]}adjustQuality(){const e=this.getAverageFrameTime(),t=this.fps;t<this.minAcceptableFPS&&e>33&&("HIGH"===this.currentQuality?this.setQuality("MEDIUM"):"MEDIUM"===this.currentQuality&&this.setQuality("LOW")),t>=this.targetFPS&&e<16&&("LOW"===this.currentQuality?this.setQuality("MEDIUM"):"MEDIUM"===this.currentQuality&&this.setQuality("HIGH"))}setAutoQualityAdjust(e){this.autoQualityAdjust=e}getMemoryInfo(){if(!performance.memory)return null;const e=performance.memory,t=e.usedJSHeapSize/1048576,s=e.totalJSHeapSize/1048576,i=e.jsHeapSizeLimit/1048576,r=t/i;return r>this.memoryWarningThreshold&&this.eventBus.emit("performance:memory-warning",{usedMemoryMB:t,totalMemoryMB:s,limitMemoryMB:i,usagePercentage:r}),{used:t.toFixed(2),total:s.toFixed(2),limit:i.toFixed(2),usagePercentage:(100*r).toFixed(2)}}getReport(){return{fps:this.fps,avgFrameTime:this.getAverageFrameTime().toFixed(2),quality:this.currentQuality,qualitySettings:this.getQualitySettings(),memory:this.getMemoryInfo()}}reset(){this.fps=60,this.frameTime=0,this.frames=0,this.frameTimes=[],this.lastFpsUpdate=performance.now(),this.lastTime=performance.now()}};t(l,"instance",null);let c=l;const m=class e{static getInstance(){return e.instance||(e.instance=new e),e.instance}constructor(){if(e.instance)throw new Error("SceneManager is a singleton. Use getInstance()");this.scene=null,this.renderer=null,this.activeCamera=null,this.renderTargets=new Map,this.activeScenes=new Map,this.animationFrameId=null,this.isInitialized=!1,this.performanceMonitor=c.getInstance(),this.eventBus=o.getInstance(),this.beforeRenderCallbacks=[],this.afterRenderCallbacks=[]}async initialize(e,t={}){if(this.isInitialized)return!0;try{const h="gpu"in navigator,o={antialias:t.antialias??!0,alpha:t.alpha??!0,powerPreference:t.powerPreference??"high-performance",stencil:t.stencil??!1,preserveDrawingBuffer:t.preserveDrawingBuffer??!1,...t};return this.renderer=new s(o),this.renderer.setSize(e.clientWidth,e.clientHeight),this.renderer.setPixelRatio(this.getOptimalPixelRatio()),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=i,this.renderer.toneMapping=r,this.renderer.toneMappingExposure=1,this.renderer.outputEncoding=n,e.appendChild(this.renderer.domElement),this.renderer.domElement.style.position="fixed",this.renderer.domElement.style.top="0",this.renderer.domElement.style.left="0",this.renderer.domElement.style.zIndex="-1",this.renderer.domElement.style.pointerEvents="none",this.scene=new a,this.scene.background=null,this.setupResizeObserver(e),this.startRenderLoop(),this.isInitialized=!0,this.eventBus.emit("scene:initialized",{hasWebGPU:h}),!0}catch(h){return this.eventBus.emit("scene:error",{error:h}),!1}}getOptimalPixelRatio(){const e=window.devicePixelRatio||1,t=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?2:2.5;return Math.min(e,t)}setupResizeObserver(e){const t=new ResizeObserver(e=>{for(const t of e){const{width:e,height:s}=t.contentRect;this.handleResize(e,s)}});t.observe(e),this.resizeObserver=t}handleResize(e,t){this.renderer&&(this.renderer.setSize(e,t),this.activeScenes.forEach(s=>{s.camera&&s.camera.isPerspectiveCamera&&(s.camera.aspect=e/t,s.camera.updateProjectionMatrix())}),this.eventBus.emit("scene:resize",{width:e,height:t}))}registerScene(e,t,s){this.activeScenes.set(e,{scene:t,camera:s,enabled:!0}),this.eventBus.emit("scene:registered",{name:e})}setActiveCamera(e){this.activeCamera=e,this.eventBus.emit("camera:changed",{camera:e})}onBeforeRender(e){this.beforeRenderCallbacks.push(e)}onAfterRender(e){this.afterRenderCallbacks.push(e)}startRenderLoop(){const e=t=>{this.animationFrameId=requestAnimationFrame(e),this.performanceMonitor.begin(),this.beforeRenderCallbacks.forEach(e=>e(t)),this.scene&&this.activeCamera&&this.renderer.render(this.scene,this.activeCamera),this.afterRenderCallbacks.forEach(e=>e(t)),this.performanceMonitor.end(),this.eventBus.emit("scene:render",{time:t})};this.animationFrameId=requestAnimationFrame(e)}pause(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null,this.eventBus.emit("scene:paused"))}resume(){this.animationFrameId||(this.startRenderLoop(),this.eventBus.emit("scene:resumed"))}dispose(){this.pause(),this.renderer&&(this.renderer.dispose(),this.renderer.domElement.remove(),this.renderer=null),this.activeScenes.forEach(({scene:e})=>{this.disposeScene(e)}),this.activeScenes.clear(),this.beforeRenderCallbacks=[],this.afterRenderCallbacks=[],this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.isInitialized=!1,this.eventBus.emit("scene:disposed")}disposeScene(e){e&&e.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>this.disposeMaterial(e)):this.disposeMaterial(e.material)),e.dispose&&e.dispose()})}disposeMaterial(e){e&&(Object.keys(e).forEach(t=>{const s=e[t];s&&s.isTexture&&s.dispose()}),e.dispose())}getStats(){return this.renderer?{triangles:this.renderer.info.render.triangles,calls:this.renderer.info.render.calls,geometries:this.renderer.info.memory.geometries,textures:this.renderer.info.memory.textures,fps:this.performanceMonitor.getFPS()}:null}};t(m,"instance",null);let d=m;export{o as E,c as P,d as S};
//# sourceMappingURL=app-core-eWg5aoaj.js.map
